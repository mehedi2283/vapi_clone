{
  "note": "Run this SQL to fix RLS errors for Assistant mapping and ensure table schema correctness.",
  "sql": "\n-- 1. Helper function for Admin check\nCREATE OR REPLACE FUNCTION public.is_admin()\nRETURNS BOOLEAN AS $$\n  SELECT EXISTS (\n    SELECT 1 FROM public.organizations\n    WHERE id = auth.uid() AND role = 'admin'\n  );\n$$ LANGUAGE sql SECURITY DEFINER;\n\n-- 2. Ensure Assistants Table Exists (Vapi IDs are strings, so use TEXT for ID)\nCREATE TABLE IF NOT EXISTS public.assistants (\n  id TEXT PRIMARY KEY,\n  org_id UUID REFERENCES public.organizations(id) ON DELETE CASCADE,\n  created_at TIMESTAMPTZ DEFAULT now()\n);\n-- Enable RLS\nALTER TABLE public.organizations ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.files ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.tools ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.assistants ENABLE ROW LEVEL SECURITY;\n\n-- 3. Organization Policies\nDROP POLICY IF EXISTS \"Org Access\" ON public.organizations;\nCREATE POLICY \"Org Access\" ON public.organizations\nFOR ALL USING (\n  id = auth.uid() \n  OR public.is_admin()\n  OR (\n    members IS NOT NULL AND \n    members @> to_jsonb(lower(auth.jwt() ->> 'email'))\n  )\n);\n\n-- 4. Assistants Mapping Policies (INSERT, SELECT, UPDATE, DELETE)\nDROP POLICY IF EXISTS \"Assistant Access\" ON public.assistants;\nCREATE POLICY \"Assistant Access\" ON public.assistants\nFOR ALL USING (\n  -- Allow access if Admin\n  public.is_admin() \n  OR \n  -- Allow access if Member/Owner of the linked Org\n  EXISTS (\n    SELECT 1 FROM public.organizations \n    WHERE id = assistants.org_id \n    AND (\n      id = auth.uid() \n      OR members @> to_jsonb(lower(auth.jwt() ->> 'email'))\n    )\n  )\n)\nWITH CHECK (\n  -- Allow insert if Admin\n  public.is_admin() \n  OR \n  -- Allow insert if Member/Owner of the target Org\n  EXISTS (\n    SELECT 1 FROM public.organizations \n    WHERE id = assistants.org_id \n    AND (\n      id = auth.uid() \n      OR members @> to_jsonb(lower(auth.jwt() ->> 'email'))\n    )\n  )\n);\n\n-- 5. Files Policies\nDROP POLICY IF EXISTS \"File Access\" ON public.files;\nCREATE POLICY \"File Access\" ON public.files\nFOR ALL USING (\n  public.is_admin() OR\n  EXISTS (\n    SELECT 1 FROM public.organizations \n    WHERE id = files.org_id \n    AND (\n      id = auth.uid() \n      OR members @> to_jsonb(lower(auth.jwt() ->> 'email'))\n    )\n  )\n);\n\n-- 6. Tools Policies\nDROP POLICY IF EXISTS \"Tool Access\" ON public.tools;\nCREATE POLICY \"Tool Access\" ON public.tools\nFOR ALL USING (\n  public.is_admin() OR\n  EXISTS (\n    SELECT 1 FROM public.organizations \n    WHERE id = tools.org_id \n    AND (\n      id = auth.uid() \n      OR members @> to_jsonb(lower(auth.jwt() ->> 'email'))\n    )\n  )\n);\n\n-- 7. RPC Function for Safe Member Deletion\nCREATE OR REPLACE FUNCTION delete_team_member(target_email text, org_id uuid)\nRETURNS void\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n  member_uid uuid;\nBEGIN\n  -- Auth check: Owner or Admin\n  IF auth.uid() <> org_id AND NOT public.is_admin() THEN\n    RAISE EXCEPTION 'Not authorized';\n  END IF;\n\n  UPDATE public.organizations\n  SET members = members - target_email\n  WHERE id = org_id;\n\n  SELECT id INTO member_uid FROM auth.users WHERE email = target_email;\n\n  IF member_uid IS NOT NULL THEN\n    DELETE FROM auth.users WHERE id = member_uid;\n  END IF;\nEND;\n$$;\n\nNOTIFY pgrst, 'reload config';"
}